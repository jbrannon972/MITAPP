<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - User Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <h1><i class="fas fa-users-cog"></i> User Management</h1>
                    <div class="header-controls">
                        <a href="index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Tool</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <div class="card">
                    <div class="card-header">
                        <h3>All Users</h3>
                        <div class="tab-controls">
                             <button class="btn btn-secondary" id="auto-create-btn"><i class="fas fa-magic"></i> Auto-Create New Techs</button>
                             <button class="btn btn-primary" id="add-user-btn"><i class="fas fa-plus"></i> Add User</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="user-table">
                            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Zone</th><th style="text-align: right;">Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalOverlay" class="modal-overlay"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBEKOGT7S8rn3NKBNysT352GFGPt9GYf8E",
            authDomain: "mit-foreasting.firebaseapp.com",
            projectId: "mit-foreasting",
            storageBucket: "mit-foreasting.firebasestorage.app",
            messagingSenderId: "1069061948061",
            appId: "1:1069061948061:web:c657b4dfb344cb7b924a74",
            measurementId: "G-Z9ZE012Y2C"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    <script src="JS/firebase-service.js"></script>
    <script src="JS/firebase-auth.js"></script>
    <script src="JS/modal-manager.js"></script>
    <script>
        // Admin Page Specific Logic
        const db = firebase.firestore();
        const modalManager = new ModalManager();

        async function loadUsers() {
            const tableBody = document.getElementById('user-table').querySelector('tbody');
            tableBody.innerHTML = '<tr><td colspan="5">Loading users...</td></tr>';

            const firebaseService = new FirebaseService();
            const staffingData = await firebaseService.loadStaffingData();
            
            const allStaff = [
                ...(staffingData.management || []),
                ...(staffingData.warehouseStaff || []),
                ...staffingData.zones.flatMap(zone => 
                    [zone.lead, ...zone.members].map(member => ({...member, zoneName: zone.name }))
                )
            ].filter(Boolean);

            if (allStaff.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">No users found.</td></tr>';
                return;
            }

            tableBody.innerHTML = allStaff.map(user => `
                <tr>
                    <td data-label="Name">${user.name || 'N/A'}</td>
                    <td data-label="Email">${user.email || 'N/A'}</td>
                    <td data-label="Role">${user.role || 'N/A'}</td>
                    <td data-label="Zone">${user.zoneName || 'N/A'}</td>
                    <td data-label="Actions" style="text-align: right;">
                        <button class="btn btn-danger btn-small" onclick="confirmDeleteUser('${user.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function confirmDeleteUser(userId) {
            modalManager.showConfirmDialog(
                'Delete User', 
                'Are you sure you want to delete this user? This will remove them from the application but not from the authentication system.', 
                `deleteUser('${userId}')`
            );
        }

        async function deleteUser(userId) {
            await authManager.deleteUser(userId);
            loadUsers(); // Refresh the list
        }

        document.getElementById('add-user-btn').addEventListener('click', async () => {
            const firebaseService = new FirebaseService();
            const staffingData = await firebaseService.loadStaffingData();
            const zoneOptions = staffingData.zones.map(z => `<option value="${z.name}">${z.name}</option>`).join('');

            const modalBody = `
                <div class="form-group">
                    <label for="new-name">Full Name</label>
                    <input type="text" id="new-name" class="form-input" placeholder="e.g., John Doe">
                </div>
                <div class="form-group">
                    <label for="new-email">Email</label>
                    <input type="email" id="new-email" class="form-input" placeholder="john.doe@entrusted.com">
                </div>
                <div class="form-group">
                    <label for="new-password">Password</label>
                    <input type="password" id="new-password" class="form-input">
                </div>
                <div class="form-group">
                    <label for="new-role">Role</label>
                    <select id="new-role" class="form-input" onchange="document.getElementById('zone-assignment').style.display = ['MIT Tech', 'Demo Tech'].includes(this.value) ? 'block' : 'none';">
                        <option value="Manager">Manager</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="MIT Lead">MIT Lead</option>
                        <option value="Fleet">Fleet</option>
                        <option value="Fleet Safety">Fleet Safety</option>
                        <option value="Auditor">Auditor</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="MIT Tech">MIT Tech</option>
                        <option value="Demo Tech">Demo Tech</option>
                    </select>
                </div>
                <div class="form-group" id="zone-assignment" style="display: none;">
                    <label for="zone-select">Assign to Zone</label>
                    <select id="zone-select" class="form-input">${zoneOptions}</select>
                </div>
            `;
            modalManager.showModal('Add New User', modalBody, [
                { text: 'Cancel', class: 'btn-secondary', onclick: 'new ModalManager().closeModal()' },
                { text: 'Create User', class: 'btn-primary', onclick: 'authManager.createUser().then(() => loadUsers())' }
            ]);
        });
        
        document.getElementById('auto-create-btn').addEventListener('click', async () => {
            if(confirm('Are you sure you want to auto-create accounts for all new techs?')) {
                await authManager.autoCreateTechAccounts();
                loadUsers();
            }
        });

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>